{% extends "base.html" %}

{% block content %}

<div class="container-fluid px-4 py-4">

   <!-- ===================================== -->
<!--             DASHBOARD HEADER          -->
<!-- ===================================== -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold text-dark mb-0">Dashboard</h4>

    <div class="dropdown" id="categoryDropdown">
        <button class="btn btn-light border dropdown-toggle" 
                data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-layer-group me-2 text-muted"></i> 
            {% if selected_category %}
                {{ selected_category.name }}
                <span class="badge bg-orange ms-2" id="themesCount">{{ themes_page.paginator.count }}</span>
            {% else %}
                Categories
            {% endif %}
        </button>

        <ul class="dropdown-menu dropdown-menu-end">
            <li>
                <a class="dropdown-item {% if not selected_category %}active-category{% endif %}" 
                   href="{% url 'dashboard' %}">
                    <i class="fas fa-layer-group me-2"></i> All Categories
                    <span class="badge bg-secondary float-end">{{ Theme.objects.count }}</span>
                </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            {% for cat in categories %}
            <li>
                <a class="dropdown-item {% if selected_category and selected_category.id == cat.id %}active-category{% endif %}" 
                   href="?category_id={{ cat.id }}{% if request.GET.threats_search %}&threats_search={{ request.GET.threats_search }}{% endif %}{% if request.GET.events_search %}&events_search={{ request.GET.events_search }}{% endif %}{% if show_archived_threats %}&show_archived_threats=1{% endif %}{% if show_archived_events %}&show_archived_events=1{% endif %}{% if request.GET.themes_per_page %}&themes_per_page={{ request.GET.themes_per_page }}{% endif %}{% if request.GET.events_per_page %}&events_per_page={{ request.GET.events_per_page }}{% endif %}">
                    <i class="fas fa-tag me-2"></i> {{ cat.name }}
                    {% with theme_count=cat.theme_set.count %}
                    {% if theme_count > 0 %}
                    <span class="badge bg-secondary float-end">{{ theme_count }}</span>
                    {% endif %}
                    {% endwith %}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- ===================================== -->
<!--               THREATS LIST            -->
<!-- ===================================== -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white border-0 pt-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="fw-bold text-primary mb-0">Threats List 
                <small class="text-muted ms-2">
                    <span id="themesTotal">{{ themes_page.paginator.count }}</span> threats
                </small>
            </h6>
            <div class="d-flex align-items-center gap-3">
                <!-- Show per page selector -->
                <div class="d-flex align-items-center me-2">
                    <span class="text-muted small me-2">Show</span>
                    <select class="form-select form-select-sm" style="width: auto;" 
                            id="themesPerPage" onchange="changeThemesPerPage(this.value)">
                        <option value="5" {% if request.GET.themes_per_page == '5' or not request.GET.themes_per_page %}selected{% endif %}>5</option>
                        <option value="10" {% if request.GET.themes_per_page == '10' %}selected{% endif %}>10</option>
                        <option value="20" {% if request.GET.themes_per_page == '20' %}selected{% endif %}>20</option>
                        <option value="50" {% if request.GET.themes_per_page == '50' %}selected{% endif %}>50</option>
                        <option value="all" {% if request.GET.themes_per_page == 'all' %}selected{% endif %}>All</option>
                    </select>
                    <span class="text-muted small ms-2">threats</span>
                </div>

                <!-- Search -->
                <div class="input-group input-group-sm" style="width: 250px;">
                    <span class="input-group-text bg-light">
                        <i class="fas fa-search"></i>
                    </span>
                    <input id="searchThemes" type="text" class="form-control" placeholder="Search threats..."
                        value="{{ request.GET.threats_search|default:'' }}"
                        oninput="debouncedSearch('threats')">
                    {% if request.GET.threats_search %}
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch('threats')">
                        <i class="fas fa-times"></i>
                    </button>
                    {% endif %}
                    <span id="themesSearchSpinner" class="input-group-text" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                    </span>
                </div>

                <!-- Show Archived -->
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox"
                           id="switchArchivedThreats"
                           {% if show_archived_threats %}checked{% endif %}
                           onchange="toggleArchived('threats')">
                    <label class="form-check-label small text-muted" for="switchArchivedThreats">
                        Show Archived
                    </label>
                </div>

                <!-- Add Threat -->
                <button class="btn btn-orange btn-sm" 
                        onclick="openAddThemeOffcanvas()">
                    <i class="fas fa-plus me-1"></i> Add Threat
                </button>
                
                <!-- View All -->
                <button class="btn btn-light btn-sm" 
                        onclick="loadThemeListOffcanvas()">
                    <i class="fas fa-list me-1"></i> View All
                </button>
            </div>
        </div>
    </div>

    <div class="card-body p-0">
        <div id="themesTableContainer">
            {% include "tracker/partials/theme_table.html" %}
        </div>
    </div>
</div>

<!-- ===================================== -->
<!--               EVENTS LIST             -->
<!-- ===================================== -->
<div class="card shadow-sm mb-5">
    <div class="card-header bg-white border-0 pt-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="fw-bold text-primary mb-0">Event List
                <small class="text-muted ms-2">
                    <span id="eventsTotal">{{ events_page.paginator.count }}</span> events
                </small>
            </h6>
            <div class="d-flex align-items-center gap-3">
                <!-- Show per page selector -->
                <div class="d-flex align-items-center me-2">
                    <span class="text-muted small me-2">Show</span>
                    <select class="form-select form-select-sm" style="width: auto;" 
                            id="eventsPerPage" onchange="changeEventsPerPage(this.value)">
                        <option value="5" {% if request.GET.events_per_page == '5' or not request.GET.events_per_page %}selected{% endif %}>5</option>
                        <option value="10" {% if request.GET.events_per_page == '10' %}selected{% endif %}>10</option>
                        <option value="20" {% if request.GET.events_per_page == '20' %}selected{% endif %}>20</option>
                        <option value="50" {% if request.GET.events_per_page == '50' %}selected{% endif %}>50</option>
                        <option value="all" {% if request.GET.events_per_page == 'all' %}selected{% endif %}>All</option>
                    </select>
                    <span class="text-muted small ms-2">events</span>
                </div>

                <!-- Search -->
                <div class="input-group input-group-sm" style="width: 250px;">
                    <span class="input-group-text bg-light">
                        <i class="fas fa-search"></i>
                    </span>
                    <input id="searchEvents" type="text" class="form-control" placeholder="Search events..."
                        value="{{ request.GET.events_search|default:'' }}"
                        oninput="debouncedSearch('events')">
                    {% if request.GET.events_search %}
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch('events')">
                        <i class="fas fa-times"></i>
                    </button>
                    {% endif %}
                    <span id="eventsSearchSpinner" class="input-group-text" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                    </span>
                </div>

                <!-- Show Archived -->
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox"
                           id="switchArchivedEvents"
                           {% if show_archived_events %}checked{% endif %}
                           onchange="toggleArchived('events')">
                    <label class="form-check-label small text-muted" for="switchArchivedEvents">
                        Show Archived
                    </label>
                </div>

                <!-- Add Event -->
                <button class="btn btn-orange btn-sm"
                    onclick="openAddEventOffcanvas()">
                    <i class="fas fa-plus me-1"></i> Add Event
                </button>

                <!-- Add Source -->
                <button class="btn btn-outline-primary btn-sm"
                    onclick="openAddSourceGlobalOffcanvas()">
                    <i class="fas fa-plus me-1"></i> Add Source
                </button>

                <!-- View All Events -->
                <a class="btn btn-light btn-sm" href="{% url 'event_list' %}">
                    <i class="fas fa-list me-1"></i> View All
                </a>
            </div>
        </div>
    </div>

    <div class="card-body p-0">
        <div id="eventsTableContainer">
            {% include "tracker/partials/event_list_partial.html" %}
        </div>
    </div>
</div>

</div>

{% endblock %}

{% block scripts %}
<style>
/* Estilos específicos de dashboard */
.offcanvas {
    transition: transform 0.35s ease-in-out !important;
}

#themesTableContainer, #eventsTableContainer {
    min-height: 200px;
    position: relative;
}

.input-group-text .spinner-border {
    width: 0.8rem;
    height: 0.8rem;
    border-width: 0.15em;
}

#searchThemes:focus, #searchEvents:focus {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
    border-color: #86b7fe !important;
    outline: none !important;
    z-index: 3;
}

.form-select-sm {
    padding: 0.25rem 2rem 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.2rem;
    width: 70px !important;
}

.d-flex.align-items-center.me-2 {
    white-space: nowrap;
}

/* Paginación */
.themes-pagination .page-link[data-page],
.events-pagination .page-link[data-page] {
    cursor: pointer;
    user-select: none;
    min-width: 32px;
    text-align: center;
    padding: 0.25rem 0.5rem;
    border: 1px solid #dee2e6;
    background-color: white;
    color: #0d6efd;
    transition: all 0.15s ease;
    text-decoration: none;
    display: inline-block;
}

.themes-pagination .page-link[data-page]:hover,
.events-pagination .page-link[data-page]:hover {
    background-color: #e9ecef;
    border-color: #dee2e6;
    transform: translateY(-1px);
}

.themes-pagination .page-item.active .page-link,
.events-pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    cursor: default;
}

.themes-pagination .page-item.disabled .page-link,
.events-pagination .page-item.disabled .page-link {
    color: #6c757d;
    pointer-events: none;
    background-color: #f8f9fa;
}

/* Sources */
.sources-container {
    max-height: 400px;
    overflow-y: auto;
    border-radius: 0 0 8px 8px;
    border: 1px solid #dee2e6;
    border-top: none;
}

.source-item {
    transition: all 0.2s ease;
    border-left: 4px solid #fd7e14 !important;
    background-color: #fffaf0;
}

.source-item:hover {
    background-color: #f8f9fa !important;
}

.source-item:last-child {
    border-bottom: none !important;
}

.event-chevron {
    transition: transform 0.3s ease;
}

.event-item:hover {
    background-color: #f8f9fa;
}

.event-item.table-active {
    background-color: #e7f1ff !important;
    border-left: 3px solid #0d6efd;
}

td.text-center {
    position: relative;
    z-index: 10;
}
</style>

<script>
// =======================================================
// DEBOUNCE PARA BÚSQUEDAS
// =======================================================
const searchTimeouts = {};

function debouncedSearch(type) {
    if (searchTimeouts[type]) clearTimeout(searchTimeouts[type]);

    const spinner = document.getElementById(`${type}SearchSpinner`);
    if (spinner) spinner.style.display = "flex";

    searchTimeouts[type] = setTimeout(() => {
        saveScrollPosition();
        if (type === "threats") loadThemesTable();
        else loadEventsTable();
    }, 350);
}

// =======================================================
// MANEJO COMPLETO DE PAGINACIÓN (THEMES)
// =======================================================
function handleThemesPagination(pageNumber) {
    saveScrollPosition();

    const spinner = document.getElementById('themesSearchSpinner');
    if (spinner) spinner.style.display = "flex";

    const params = new URLSearchParams(window.location.search);

    if (pageNumber > 1) params.set("threat_page", pageNumber);
    else params.delete("threat_page");

    const searchTerm = document.getElementById("searchThemes").value.trim();
    const showArchived = document.getElementById("switchArchivedThreats").checked;
    const perPage = document.getElementById("themesPerPage").value;

    if (searchTerm) params.set("threats_search", searchTerm);
    else params.delete("threats_search");

    if (showArchived) params.set("show_archived_threats", "1");
    else params.delete("show_archived_threats");

    if (perPage !== "5") params.set("themes_per_page", perPage);
    else params.delete("themes_per_page");

    params.set("partial", "themes");

    const container = document.getElementById("themesTableContainer");
    const oldContent = container.innerHTML;

    container.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-orange"></div>
            <p class="text-muted mt-2">Loading page ${pageNumber}...</p>
        </div>
    `;

    fetch(`{% url 'dashboard' %}?${params}`, 
        { headers: { "X-Requested-With": "XMLHttpRequest" } }
    )
    .then(r => r.text())
    .then(html => {
        container.innerHTML = html;
        window.history.pushState({}, "", `${window.location.pathname}?${params}`);

        const count = html.match(/<span id="themesTotal">(\d+)<\/span>/);
        if (count) document.getElementById("themesTotal").textContent = count[1];

        setTimeout(() => restoreScrollPosition(), 80);

        if (spinner) spinner.style.display = "none";
    })
    .catch(err => {
        console.error(err);
        container.innerHTML = oldContent;
        if (spinner) spinner.style.display = "none";
    });
}

// =======================================================
// PAGINACIÓN EVENTS
// =======================================================
function handleEventsPagination(pageNumber) {
    saveScrollPosition();

    const spinner = document.getElementById('eventsSearchSpinner');
    if (spinner) spinner.style.display = "flex";

    const params = new URLSearchParams(window.location.search);

    if (pageNumber > 1) params.set("event_page", pageNumber);
    else params.delete("event_page");

    const searchTerm = document.getElementById('searchEvents').value.trim();
    const showArchived = document.getElementById('switchArchivedEvents').checked;
    const perPage = document.getElementById('eventsPerPage').value;

    if (searchTerm) params.set("events_search", searchTerm);
    else params.delete("events_search");

    if (showArchived) params.set("show_archived_events", "1");
    else params.delete("show_archived_events");

    if (perPage !== "5") params.set("events_per_page", perPage);
    else params.delete("events_per_page");

    params.set("partial", "events");

    const container = document.getElementById("eventsTableContainer");
    const oldContent = container.innerHTML;

    container.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-orange"></div>
            <p class="text-muted mt-2">Loading events...</p>
        </div>
    `;

    fetch(`{% url 'dashboard' %}?${params}`, 
        { headers: { "X-Requested-With": "XMLHttpRequest" } }
    )
    .then(r => r.text())
    .then(html => {
        container.innerHTML = html;

        const count = html.match(/<span id="eventsTotal">(\d+)<\/span>/);
        if (count) document.getElementById("eventsTotal").textContent = count[1];

        window.history.replaceState({}, "", `${window.location.pathname}?${params}`);

        setTimeout(() => restoreScrollPosition(), 80);

        if (spinner) spinner.style.display = "none";
    })
    .catch(err => {
        console.error(err);
        container.innerHTML = oldContent;
        if (spinner) spinner.style.display = "none";
    });
}

// =======================================================
// TABLAS AJAX (RELOAD COMPLETO)
// =======================================================
function loadThemesTable() {
    const params = new URLSearchParams(window.location.search);

    const searchTerm = document.getElementById('searchThemes').value.trim();
    const showArchived = document.getElementById('switchArchivedThreats').checked;
    const perPage = document.getElementById('themesPerPage').value;

    if (searchTerm) params.set("threats_search", searchTerm);
    else params.delete("threats_search");

    if (showArchived) params.set("show_archived_threats", 1);
    else params.delete("show_archived_threats");

    if (perPage !== "5") params.set("themes_per_page", perPage);
    else params.delete("themes_per_page");

    params.delete("threat_page");
    params.set("partial", "themes");

    const container = document.getElementById("themesTableContainer");
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-orange"></div>
        </div>
    `;

    fetch(`{% url 'dashboard' %}?${params}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(r => r.text())
        .then(html => {
            container.innerHTML = html;

            const count = html.match(/<span id="themesTotal">(\d+)<\/span>/);
            if (count) document.getElementById("themesTotal").textContent = count[1];

            window.history.replaceState({}, "", `${window.location.pathname}?${params}`);
        });
}

function loadEventsTable() {
    const params = new URLSearchParams(window.location.search);

    const searchTerm = document.getElementById('searchEvents').value.trim();
    const showArchived = document.getElementById('switchArchivedEvents').checked;
    const perPage = document.getElementById('eventsPerPage').value;

    if (searchTerm) params.set("events_search", searchTerm);
    else params.delete("events_search");

    if (showArchived) params.set("show_archived_events", 1);
    else params.delete("show_archived_events");

    if (perPage !== "5") params.set("events_per_page", perPage);
    else params.delete("events_per_page");

    params.delete("event_page");
    params.set("partial", "events");

    const container = document.getElementById("eventsTableContainer");
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-orange"></div>
        </div>
    `;

    fetch(`{% url 'dashboard' %}?${params}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(r => r.text())
        .then(html => {
            container.innerHTML = html;

            const count = html.match(/<span id="eventsTotal">(\d+)<\/span>/);
            if (count) document.getElementById("eventsTotal").textContent = count[1];

            window.history.replaceState({}, "", `${window.location.pathname}?${params}`);
        });
}

// =======================================================
// SCROLL POSITION MANAGER
// =======================================================
let scrollPosition = { top: 0, inputId: null };

function saveScrollPosition() {
    scrollPosition.top = window.scrollY || document.documentElement.scrollTop;

    const active = document.activeElement;
    if (active && (active.id === "searchThemes" || active.id === "searchEvents")) {
        scrollPosition.inputId = active.id;
    }
}

function restoreScrollPosition() {
    if (scrollPosition.top > 0) {
        window.scrollTo({ top: scrollPosition.top, behavior: "smooth" });
    }

    if (scrollPosition.inputId) {
        const input = document.getElementById(scrollPosition.inputId);
        if (input) {
            setTimeout(() => {
                input.focus();
                input.setSelectionRange(input.value.length, input.value.length);
            }, 150);
        }
    }
}

// =======================================================
// CLEAR SEARCH
// =======================================================
function clearSearch(type) {
    const input = document.getElementById(type === "threats" ? "searchThemes" : "searchEvents");
    input.value = "";

    const spinner = document.getElementById(`${type}SearchSpinner`);
    if (spinner) spinner.style.display = "flex";

    if (type === "threats") loadThemesTable();
    else loadEventsTable();
}

// =======================================================
// TOGGLE ARCHIVED
// =======================================================
function toggleArchived(type) {
    saveScrollPosition();

    const spinner = document.getElementById(`${type}SearchSpinner`);
    if (spinner) spinner.style.display = "flex";

    if (type === "threats") loadThemesTable();
    else loadEventsTable();
}

// =======================================================
// CHANGE PER PAGE
// =======================================================
function changeThemesPerPage(value) {
    saveScrollPosition();
    loadThemesTable();
}

function changeEventsPerPage(value) {
    saveScrollPosition();
    loadEventsTable();
}

// =======================================================
// INICIALIZACIÓN
// =======================================================
document.addEventListener("DOMContentLoaded", function () {
    console.log("Dashboard fully initialized.");

    // Enter en búsqueda
    document.getElementById("searchThemes")?.addEventListener("keypress", e => {
        if (e.key === "Enter") { e.preventDefault(); loadThemesTable(); }
    });
    document.getElementById("searchEvents")?.addEventListener("keypress", e => {
        if (e.key === "Enter") { e.preventDefault(); loadEventsTable(); }
    });

    // Guardar scroll en inputs
    document.getElementById("searchThemes")?.addEventListener("focus", saveScrollPosition);
    document.getElementById("searchEvents")?.addEventListener("focus", saveScrollPosition);

    // Paginación en delegación
    document.addEventListener("click", function (e) {
        const themeBtn = e.target.closest(".themes-pagination .page-link[data-page]");
        if (themeBtn) {
            e.preventDefault();
            handleThemesPagination(parseInt(themeBtn.dataset.page));
        }

        const eventBtn = e.target.closest(".events-pagination .page-link[data-page]");
        if (eventBtn) {
            e.preventDefault();
            handleEventsPagination(parseInt(eventBtn.dataset.page));
        }
    });

    // =======================================================
// OPEN ADD EVENT OFFCANVAS
// =======================================================
function openAddEventOffcanvas() {
    saveScrollPosition();
    
    fetch("{% url 'add_event_offcanvas' %}", {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const offcanvasHTML = `
                <div class="offcanvas offcanvas-end" tabindex="-1" id="addEventOffcanvas" style="width: 800px;">
                    <div class="offcanvas-body p-0">
                        ${data.html}
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', offcanvasHTML);
            const offcanvasEl = document.getElementById('addEventOffcanvas');
            const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
            bsOffcanvas.show();
            
            // Inicializar listeners después de mostrar
            setTimeout(() => {
                initEventOffcanvas();
            }, 100);
        }
    })
    .catch(err => console.error('Error loading event offcanvas:', err));
}

// =======================================================
// OPEN ADD SOURCE GLOBAL OFFCANVAS
// =======================================================
function openAddSourceGlobalOffcanvas() {
    saveScrollPosition();
    
    fetch("{% url 'add_source_global_offcanvas' %}", {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(r => {
        if (r.ok) return r.text();
        throw new Error('Failed to load');
    })
    .then(html => {
        const offcanvasHTML = `
            <div class="offcanvas offcanvas-end" tabindex="-1" id="addSourceGlobalOffcanvas" style="width: 900px;">
                ${html}
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', offcanvasHTML);
        const offcanvasEl = document.getElementById('addSourceGlobalOffcanvas');
        const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
        bsOffcanvas.show();
        
        // Inicializar scripts del offcanvas
        setTimeout(() => {
            initSourceOffcanvas();
        }, 100);
    })
    .catch(err => console.error('Error loading source offcanvas:', err));
}

// =======================================================
// INITIALIZE EVENT OFFCANVAS FUNCTIONS
// =======================================================
function initEventOffcanvas() {
    const form = document.querySelector('#addEventOffcanvas form');
    if (!form) return;
    
    // Agregar event listener para el submit
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitEventForm(this);
    });
    
    // Inicializar taxonomía dinámica
    initTaxonomyHandlers();
}

// =======================================================
// SUBMIT EVENT FORM (AJAX)
// =======================================================
function submitEventForm(form) {
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <i class="fas fa-spinner fa-spin me-2"></i>
        Saving...
    `;
    
    const formData = new FormData(form);
    
    fetch(form.action || "{% url 'add_event_offcanvas' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Mostrar mensaje de éxito
            const alertHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Cerrar offcanvas después de 1.5 segundos
            setTimeout(() => {
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('addEventOffcanvas'));
                offcanvas.hide();
                
                // Redirigir o recargar
                if (data.redirect_url) {
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 300);
                }
            }, 1500);
        } else {
            // Mostrar errores
            showFormErrors(form, data.errors);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    })
    .catch(err => {
        console.error('Error:', err);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    });
}

// =======================================================
// INITIALIZE SOURCE OFFCANVAS
// =======================================================
function initSourceOffcanvas() {
    const form = document.querySelector('#addSourceGlobalOffcanvas form');
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitSourceForm(this);
    });
    
    // Inicializar contador de nombre
    const nameInput = form.querySelector('input[name="name"]');
    const nameCounter = document.getElementById('nmCnt');
    if (nameInput && nameCounter) {
        nameCounter.textContent = nameInput.value.length;
        nameInput.addEventListener('input', () => {
            nameCounter.textContent = nameInput.value.length;
        });
    }
}

// =======================================================
// SUBMIT SOURCE FORM (AJAX)
// =======================================================
function submitSourceForm(form) {
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <i class="fas fa-spinner fa-spin me-2"></i>
        Saving...
    `;
    
    const formData = new FormData(form);
    
    fetch(form.action || "{% url 'add_source_global_offcanvas' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Mostrar mensaje de éxito
            const alertHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    Source created successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Cerrar offcanvas después de 1.5 segundos
            setTimeout(() => {
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('addSourceGlobalOffcanvas'));
                offcanvas.hide();
                
                // Redirigir o recargar
                if (data.redirect_url) {
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 300);
                } else {
                    // Recargar la tabla de events si estamos en dashboard
                    loadEventsTable();
                }
            }, 1500);
        } else {
            // Mostrar errores
            showFormErrors(form, data.errors);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    })
    .catch(err => {
        console.error('Error:', err);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    });
}

// =======================================================
// HELPER: SHOW FORM ERRORS
// =======================================================
function showFormErrors(form, errors) {
    // Limpiar errores anteriores
    form.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
    });
    form.querySelectorAll('.invalid-feedback').forEach(el => {
        el.remove();
    });
    
    // Mostrar nuevos errores
    for (const [field, messages] of Object.entries(errors)) {
        const input = form.querySelector(`[name="${field}"]`);
        if (input) {
            input.classList.add('is-invalid');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback d-block';
            errorDiv.textContent = messages.join(', ');
            input.parentNode.appendChild(errorDiv);
        } else {
            // Error general
            const alertHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${messages.join(', ')}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            form.insertAdjacentHTML('afterbegin', alertHTML);
        }
    }
}

// =======================================================
// INITIALIZE TAXONOMY HANDLERS FOR EVENT FORM
// =======================================================
function initTaxonomyHandlers() {
    // Taxonomía dinámica - si existe en el form
    const lv1Checkboxes = document.querySelectorAll('input[name="risk_taxonomy_lv1"]');
    if (lv1Checkboxes.length > 0) {
        lv1Checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                updateTaxonomyOptions();
            });
        });
        
        // Inicializar
        updateTaxonomyOptions();
    }
}

function updateTaxonomyOptions() {
    const selectedLv1 = Array.from(
        document.querySelectorAll('input[name="risk_taxonomy_lv1"]:checked')
    ).map(cb => cb.value);
    
    const selectedLv2 = Array.from(
        document.querySelectorAll('input[name="risk_taxonomy_lv2"]:checked')
    ).map(cb => cb.value);
    
    const form = document.querySelector('#addEventOffcanvas form');
    if (!form) return;
    
    const formData = new FormData();
    selectedLv1.forEach(v => formData.append('risk_taxonomy_lv1', v));
    selectedLv2.forEach(v => formData.append('risk_taxonomy_lv2', v));
    formData.append('__partial__', '1');
    
    fetch(form.action || "{% url 'add_event_offcanvas' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Actualizar las opciones de Level 2 y Level 3
            const container = document.querySelector('#addEventOffcanvas');
            const lv2Div = container.querySelector('#lv2-options');
            const lv3Div = container.querySelector('#lv3-options');
            
            if (lv2Div) lv2Div.innerHTML = data.html;
            if (lv3Div) lv3Div.innerHTML = data.html;
        }
    })
    .catch(err => console.error('Error updating taxonomy:', err));
}

    // Manejo de back / forward
    window.addEventListener("popstate", function () {
        loadThemesTable();
        loadEventsTable();
    });
});
</script>
{% endblock %}