def view_theme(request, pk):
    theme = get_object_or_404(Theme, pk=pk)
    request.session['last_viewed_theme'] = theme.pk

    # sort: name|-name|date|-date|risk|-risk
    sort = request.GET.get("sort") or "-risk"

    events = theme.events.all()

    # Mapeo de severidad para ordenar Risk Rating (CRITICAL > HIGH > Moderate > LOW)
    risk_order = Case(
        When(risk_rating="CRITICAL", then=1),
        When(risk_rating="HIGH", then=2),
        When(risk_rating="MODERATE", then=3),
        When(risk_rating="LOW", then=4),
        default=5,
        output_field=IntegerField(),
    )

    if sort == "name":
        events = events.order_by("name", "-id")
    elif sort == "-name":
        events = events.order_by("-name", "-id")
    elif sort == "date":
        events = events.order_by("date_identified", "-id")
    elif sort == "-date":
        events = events.order_by("-date_identified", "-id")
    elif sort == "risk":
        events = events.annotate(rk=risk_order).order_by("rk", "name", "-id")
    elif sort == "-risk":
        events = events.annotate(rk=risk_order).order_by("-rk", "name", "-id")
    else:
        # default: por severidad descendente
        events = events.annotate(rk=risk_order).order_by("rk", "name", "-id")

    return render(request, 'tracker/theme_detail.html', {
        'theme': theme,
        'events': events,
        'sort': sort,
    })
