{% load static %}

<!-- ===================== EDIT THEME OFFCANVAS ===================== -->
<div class="offcanvas offcanvas-end show"
     tabindex="-1"
     style="width: 600px;"
     data-bs-scroll="true"
     data-bs-backdrop="true">

    <!-- ===================== HEADER ===================== -->
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold">
            <i class="fas fa-pen me-2 text-orange"></i>
            Edit Threat
        </h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="offcanvas"></button>
    </div>

    <!-- ===================== BODY ===================== -->
    <div class="offcanvas-body">

        <div id="editThemeErrors"
             class="alert alert-danger d-none mb-3">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span id="editErrorMessage"></span>
        </div>

        <form id="editThemeForm"
              method="post"
              action="{% url 'edit_theme_offcanvas' theme.id %}"
              novalidate>

            {% csrf_token %}

            <!-- ================= HIDDEN ================= -->
            <input type="hidden"
                   name="risk_rating"
                   id="id_risk_rating"
                   value="{{ theme.risk_rating }}">

            <!-- ================= BASIC INFO ================= -->
            <div class="mb-4">
                <h6 class="fw-bold text-secondary mb-3">Basic Information</h6>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Category <span class="text-danger">*</span>
                    </label>
                    <select name="category"
                            class="form-select"
                            required>
                        <option value="">Select category</option>
                        {% for c in categories %}
                            <option value="{{ c.id }}"
                                {% if c.id == theme.category.id %}selected{% endif %}>
                                {{ c.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Name <span class="text-danger">*</span>
                    </label>
                    <input type="text"
                           name="name"
                           class="form-control"
                           value="{{ theme.name }}"
                           minlength="3"
                           maxlength="50"
                           required>
                </div>
            </div>

            <!-- ================= CLASSIFICATION ================= -->
            <div class="mb-4">
                <h6 class="fw-bold text-secondary mb-3">Classification</h6>

                <label class="form-label fw-bold mb-3">
                    Risk Rating <span class="text-danger">*</span>
                </label>

                <div id="editRiskRatingError"
                     class="alert alert-danger small d-none">
                    Please select a risk rating.
                </div>

                <div class="row g-3 mb-4">

                    <div class="col-6">
                        <div class="risk-card {% if theme.risk_rating == 'low' %}selected{% endif %}"
                             data-risk="low">
                            <i class="fas fa-check-circle text-success mb-2"></i>
                            <div>Low</div>
                        </div>
                    </div>

                    <div class="col-6">
                        <div class="risk-card {% if theme.risk_rating == 'moderate' %}selected{% endif %}"
                             data-risk="moderate">
                            <i class="fas fa-exclamation-circle text-warning mb-2"></i>
                            <div>Moderate</div>
                        </div>
                    </div>

                    <div class="col-6">
                        <div class="risk-card {% if theme.risk_rating == 'high' %}selected{% endif %}"
                             data-risk="high">
                            <i class="fas fa-exclamation-triangle text-orange mb-2"></i>
                            <div>High</div>
                        </div>
                    </div>

                    <div class="col-6">
                        <div class="risk-card {% if theme.risk_rating == 'critical' %}selected{% endif %}"
                             data-risk="critical">
                            <i class="fas fa-skull-crossbones text-danger mb-2"></i>
                            <div>Critical</div>
                        </div>
                    </div>

                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Onset Timeline <span class="text-danger">*</span>
                    </label>
                    <select name="onset_timeline"
                            class="form-select"
                            required>
                        {% for value,label in ONSET_TIMELINE_CHOICES %}
                            <option value="{{ value }}"
                                {% if theme.onset_timeline == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- ================= ACTIONS ================= -->
            <div class="pt-3 mt-4 border-top d-flex justify-content-between">
                <button type="button"
                        class="btn btn-outline-secondary"
                        data-bs-dismiss="offcanvas">
                    Cancel
                </button>

                <button type="submit"
                        class="btn btn-primary">
                    Save Changes
                </button>
            </div>

        </form>
    </div>
</div>

<!-- ===================== SCRIPT ===================== -->
<script>
document.addEventListener('click', function (e) {
    const card = e.target.closest('.risk-card');
    if (!card) return;

    document.querySelectorAll('.risk-card')
        .forEach(c => c.classList.remove('selected'));

    card.classList.add('selected');
    document.getElementById('id_risk_rating').value = card.dataset.risk;
});

document.addEventListener("submit", function (e) {
    const form = e.target;
    if (form.id !== "editThemeForm") return;

    e.preventDefault();

    const risk = document.getElementById("id_risk_rating");
    const error = document.getElementById("editRiskRatingError");
    error.classList.add("d-none");

    if (!risk.value) {
        error.classList.remove("d-none");
        return;
    }

    fetch(form.action, {
        method: "POST",
        body: new FormData(form),
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) return alert("Error saving threat");

        bootstrap.Offcanvas.getInstance(
            form.closest(".offcanvas")
        )?.hide();

        if (typeof loadThemesTable === "function") {
            loadThemesTable();
        }
    })
    .catch(() => alert("Unexpected error"));
});
</script>

<!-- ===================== STYLES ===================== -->
<style>
.risk-card {
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 18px;
    text-align: center;
    cursor: pointer;
    transition: all .2s ease;
    background: #fff;
}
.risk-card:hover {
    border-color: #adb5bd;
}
.risk-card.selected {
    border-color: #f26522;
    background: rgba(242,101,34,.08);
}
.text-orange {
    color: #fd7e14;
}
</style>
