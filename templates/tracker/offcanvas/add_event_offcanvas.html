{% load widget_tweaks %}

<div class="p-4" style="background-color: #f8f9fa;">
  <form id="addEventFormOffcanvas" method="post" action="{% url 'add_event_offcanvas' %}" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- BASIC INFORMATION & CLASSIFICATION -->
    <div class="row mb-4">
      <!-- BASIC INFORMATION -->
      <div class="col-md-6 mb-3 mb-md-0">
        <div class="card shadow-sm h-100 border-0">
          <div class="card-header bg-light border-bottom p-3" >
            <h6 class="m-0 text-dark fw-semibold">
              <i class="fas fa-info-circle me-2"></i>Basic Information
            </h6>
          </div>

          <div class="card-body p-3">
            <!-- THEME -->
            <div class="mb-3">
              <label class="form-label fw-semibold" style="font-size: 0.9rem;">
                Threat <span class="text-danger">*</span>
              </label>
              {{ form.theme|add_class:"form-select form-select-sm" }}
              <div class="invalid-feedback">Please select a threat.</div>
            </div>

            <!-- NAME -->
            <div class="mb-3" id="name-group">
              <label class="form-label fw-semibold" style="font-size: 0.9rem;">
                Event Name <span class="text-danger">*</span>
              </label>
              {{ form.name|add_class:"form-control form-control-sm"|attr:"id=name"|attr:"maxlength=30"|attr:"minlength=3"|attr:"pattern=.*\S.*"|attr:"required=required" }}

              <div class="form-text text-muted text-end" style="font-size: 0.75rem;">
                <span id="name-char-count">0</span>/30 characters
              </div>

              <div class="invalid-feedback" id="name-error">
                Event name is required (3‚Äì30 characters, no whitespace only).
              </div>
            </div>

            <!-- DATE IDENTIFIED -->
            <div class="mb-3">
              <label class="form-label fw-semibold" style="font-size: 0.9rem;">
                Date Identified <span class="text-danger">*</span>
              </label>
              <input type="date" name="date_identified" id="date_identified" class="form-control form-control-sm" required>
              <div class="form-text text-muted" style="font-size: 0.75rem;">Cannot be a future date.</div>
              <div class="invalid-feedback" id="date-error">Please provide a valid (not future) date.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- CLASSIFICATION -->
      <div class="col-md-6">
        <div class="card shadow-sm h-100 border-0">
          <div class="card-header bg-light border-bottom p-3" >
            <h6 class="m-0 text-dark fw-semibold">
              <i class="fas fa-tags me-2"></i>Classification
            </h6>
          </div>

          <div class="card-body p-3">
            <!-- RISK RATING -->
            <div class="mb-3">
              <label class="form-label fw-semibold" style="font-size: 0.9rem;">
                Risk Rating <span class="text-danger">*</span>
              </label>

              <select class="form-select hidden"
                      id="risk_rating"
                      name="risk_rating"
                      required
                      style="display:none;">
                <option value="">Select risk rating</option>
                {% for value, label in form.risk_rating.field.choices %}
                  <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>

              <div id="risk-tiles" class="risk-rating-container mt-2" aria-describedby="risk-error">
                <div class="risk-item" data-value="low" role="button" tabindex="0">
                  <div class="rating-display">
                    <span class="risk-color risk-low"></span>
                    <span class="ms-2">Low</span>
                  </div>
                </div>

                <div class="risk-item" data-value="moderate" role="button" tabindex="0">
                  <div class="rating-display">
                    <span class="risk-color risk-medium"></span>
                    <span class="ms-2">Moderate</span>
                  </div>
                </div>

                <div class="risk-item" data-value="high" role="button" tabindex="0">
                  <div class="rating-display">
                    <span class="risk-color risk-high"></span>
                    <span class="ms-2">High</span>
                  </div>
                </div>

                <div class="risk-item" data-value="critical" role="button" tabindex="0">
                  <div class="rating-display">
                    <span class="risk-color risk-critical"></span>
                    <span class="ms-2">Critical</span>
                  </div>
                </div>
              </div>

              <div id="risk-error" class="invalid-feedback d-block" style="display:none;">
                Please select a risk rating.
              </div>
            </div>

            <!-- STATUS -->
            <div class="mb-3">
              <label class="form-label fw-semibold" style="font-size: 0.9rem;">
                Phase <span class="text-danger">*</span>
              </label>
              {{ form.status|add_class:"form-select form-select-sm" }}
              <div class="invalid-feedback">Please select a status.</div>
            </div>

            <!-- CONTROL IN PLACE -->
            <div class="form-check form-switch">
              {{ form.control_in_place|add_class:"form-check-input"|attr:"id=control_in_place" }}
              <label class="form-check-label fw-semibold" for="control_in_place" style="font-size: 0.9rem;">
                Control in Place
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    
    <!-- IMPACTED BUSINESS LINES -->
    <div class="card mb-4 shadow-sm border-0">
      <div class="card-header bg-light border-bottom p-3" >
        <h6 class="m-0 text-dark fw-semibold">
          <i class="fas fa-building me-2"></i>Impacted Business Lines
        </h6>
      </div>

      <div class="card-body p-3">
        <div class="business-lines-container">
          <!-- ALL checkbox -->
          <div class="form-check form-check-inline mb-2">
            <input class="form-check-input" type="checkbox" name="impacted_lines" value="All" id="lob_all">
            <label class="form-check-label" for="lob_all" style="font-size: 0.9rem;">
              <strong>All</strong>
            </label>
          </div>

          <!-- TARGET checkboxes (los que se marcan con "All") -->
          {% for value,label in form.fields.impacted_lines.choices %}
            {% if value != "All" and value != "Evaluation in progress" %}
              <div class="form-check form-check-inline mb-2">
                <input class="form-check-input lob-target" type="checkbox" name="impacted_lines" value="{{ value }}" id="lob_{{ forloop.counter }}">
                <label class="form-check-label" for="lob_{{ forloop.counter }}" style="font-size: 0.9rem;">
                  {{ value }}
                </label>
              </div>
            {% endif %}
          {% endfor %}

          <!-- EXEMPT checkbox (NO se marca con "All") -->
          <div class="form-check form-check-inline mb-2">
            <input class="form-check-input lob-exempt" type="checkbox" name="impacted_lines" value="Evaluation in progress" id="lob_eval">
            <label class="form-check-label" for="lob_eval" style="font-size: 0.9rem;">
              <em>Evaluation in progress</em>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- RISK TAXONOMY -->
    
    <div class="card mb-4 shadow-sm border-0">
      <div class="card-header bg-light border-bottom p-3" >
        <h6 class="m-0 text-dark fw-semibold">
          <i class="fas fa-sitemap me-2"></i>Risk Taxonomy
        </h6>
      </div>
      <div class="card-body p-3">
        <div class="row g-3">
          <!-- LEVEL 1 -->
          <div class="col-md-4">
            <div class="taxonomy-section">
              <div class="taxonomy-header">
                <span style="font-size: 0.85rem;">Level 1 <span class="text-danger">*</span></span>
                <span class="taxonomy-count">0/0</span>
              </div>
              <div class="taxonomy-container" id="taxonomy-lv1-container" aria-describedby="lv1-error">
                {{ form.risk_taxonomy_lv1 }}
              </div>
              <div class="selected-options"></div>
              <div id="lv1-error" class="invalid-feedback" style="display:none;">
                Please select at least one Level 1 option.
              </div>
            </div>
          </div>

          <!-- LEVEL 2 -->
          <div class="col-md-4">
            <div class="taxonomy-section" id="lv2-container">
              <div class="taxonomy-header">
                <span style="font-size: 0.85rem;">Level 2 <span class="text-danger">*</span></span>
                <span class="taxonomy-count">0/0</span>
              </div>
              <div class="taxonomy-container" id="lv2-options" aria-describedby="lv2-error">
                {{ form.risk_taxonomy_lv2 }}
              </div>
              <div class="selected-options"></div>
              <div id="lv2-error" class="invalid-feedback" style="display:none;">
                Please select at least one Level 2 option.
              </div>
            </div>
          </div>

          <!-- LEVEL 3 -->
          <div class="col-md-4">
            <div class="taxonomy-section" id="lv3-container">
              <div class="taxonomy-header">
                <span style="font-size: 0.85rem;">Level 3 <span class="text-danger">*</span></span>
                <span class="taxonomy-count">0/0</span>
              </div>
              <div class="taxonomy-container" id="lv3-options" aria-describedby="lv3-error">
                {{ form.risk_taxonomy_lv3 }}
              </div>
              <div class="selected-options"></div>
              <div id="lv3-error" class="invalid-feedback" style="display:none;">
                Please select at least one Level 3 option.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- DESCRIPTION -->
    <div class="card mb-4 shadow-sm border-0">
      <div class="card-header p-3">
        <h6 class="m-0 text-dark fw-semibold">
          <i class="fas fa-align-left me-2"></i>Description & Impact Assessment
        </h6>
      </div>
      <div class="card-body p-3">
        <label class="form-label fw-semibold" style="font-size: 0.9rem;">
          Description <span class="text-danger">*</span>
        </label>
        {{ form.description|add_class:"form-control"|attr:"rows=4"|attr:"required=required"|attr:"style=font-size: 0.9rem;" }}
        <div class="invalid-feedback">Please enter a description.</div>
      </div>
    </div>

    <!-- BUTTONS -->
    <div class="d-flex justify-content-between gap-2 sticky-bottom bg-white p-3 border-top" style="margin: -1rem -1rem -1rem -1rem;">
      <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="offcanvas">
        <i class="fas fa-times me-1"></i>Cancel
      </button>
      <button type="submit" class="btn btn-primary btn-sm">
        <i class="fas fa-save me-1"></i>Save Event
      </button>
    </div>
  </form>
</div>

<!-- ESTILOS -->
<style>
  .risk-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
  }
  .risk-low { background: #28a745; }
  .risk-medium { background: #ffc107; }
  .risk-high { background: #dc3545; }
  .risk-critical { background: #6c757d; }

  .risk-rating-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
  }
  .risk-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .risk-item:hover {
    background: #f8f9fa;
  }
  .risk-item.selected {
    background: #e9ecef;
    border-color: #3498db;
  }
  .rating-display {
    display: flex;
    align-items: center;
  }

  .taxonomy-section {
    transition: all 0.3s ease;
  }
  .taxonomy-header {
    background: #e9ecef;
    padding: 8px 12px;
    border-radius: 6px;
    margin-bottom: 10px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .taxonomy-count {
    background: #6c757d;
    color: #fff;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: .75rem;
  }
  .option-count {
    background: #6c757d;
    color: #fff;
    border-radius: 10px;
    padding: 1px 6px;
    font-size: 0.65rem;
    margin-left: 6px;
  }
  .taxonomy-container {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: .375rem;
    padding: 10px;
    background: white;
    scroll-behavior: smooth;
  }
  .taxonomy-container::-webkit-scrollbar {
    width: 10px;
  }
  .taxonomy-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  .taxonomy-container::-webkit-scrollbar-thumb {
    background: #a8a8a8;
    border-radius: 4px;
  }
  .taxonomy-container::-webkit-scrollbar-thumb:hover {
    background: #888;
  }
  .taxonomy-container .form-check {
    margin-bottom: 8px;
  }
  .taxonomy-group {
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
  }
  .taxonomy-group:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .taxonomy-group .fw-bold {
    margin-bottom: 4px;
    font-size: 0.75rem;
    color: #6c757d;
  }
  .selected-options {
    background: #e7f3ff;
    border-left: 4px solid #007bff;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
    max-height: 120px;
    overflow-y: auto;
    display: none;
  }
  .selected-item {
    background: #d1e7ff;
    padding: 4px 8px;
    border-radius: 4px;
    margin: 3px;
    font-size: .85rem;
    display: inline-block;
  }

  .taxonomy-section.is-invalid .taxonomy-header {
    border: 1px solid #dc3545;
  }
  .risk-tiles-invalid {
    border: 1px dashed #dc3545;
    border-radius: 8px;
    padding: 6px;
  }

  @keyframes shake {
    10%, 90% { transform: translateX(-1px); }
    20%, 80% { transform: translateX(2px); }
    30%, 50%, 70% { transform: translateX(-4px); }
    40%, 60% { transform: translateX(4px); }
  }
  .shake {
    animation: shake 0.4s;
  }

  #name-char-count.text-warning {
    color: #ffc107 !important;
  }
  #name-char-count.text-danger {
    color: #dc3545 !important;
  }

  .business-lines-container .form-check-label {
    cursor: pointer;
  }
  .business-lines-container .form-check-input:disabled + label {
    opacity: 0.6;
  }

  .sticky-bottom {
    position: sticky;
    bottom: 0;
    z-index: 10;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  }
</style>

<!-- JAVASCRIPT -->
<script>
(function() {
  'use strict';

  console.log('üöÄ Initializing Offcanvas Event Form...');

  // üî• INCREMENTAR timeout a 200ms para asegurar que el DOM est√© listo
  setTimeout(function() {
    const form = document.getElementById('addEventFormOffcanvas');
    
    if (!form) {
      console.error('‚ùå Form not found in offcanvas');
      return;
    }

    console.log('‚úÖ Form found:', form);

    const lv1Box = document.getElementById("taxonomy-lv1-container");
    const lv2Box = document.getElementById("lv2-options");
    const lv3Box = document.getElementById("lv3-options");

    if (!lv1Box || !lv2Box || !lv3Box) {
      console.error('‚ùå Taxonomy containers not found', {lv1Box, lv2Box, lv3Box});
      return;
    }

    console.log('‚úÖ Taxonomy containers found');

    // =============================================
    // BUSINESS LINES LOGIC
    // =============================================
    function setupLOBLogic() {
      console.log('üìã Setting up Business Lines logic...');
      
      const container = document.querySelector(".business-lines-container");
      if (!container) {
        console.error('‚ùå Business lines container not found');
        return;
      }

      const allCb = container.querySelector('input[value="All"]');
      if (!allCb) {
        console.error('‚ùå "All" checkbox not found');
        return;
      }

      const targets = Array.from(container.querySelectorAll('.lob-target'));
      const exempts = Array.from(container.querySelectorAll('.lob-exempt'));

      console.log('‚úÖ Found Business Lines:', {
        all: allCb,
        targets: targets.length,
        exempts: exempts.length
      });

      if (targets.length === 0) {
        console.error('‚ùå NO target checkboxes found! Make sure they have class="lob-target"');
        return;
      }

      function applyAllState(checked) {
        console.log(`üîÑ Applying "All" state: ${checked}`);
        
        targets.forEach(cb => {
          cb.checked = checked;
          cb.disabled = checked;
        });
        
        exempts.forEach(cb => {
          cb.checked = false;
          cb.disabled = checked;
        });
      }

      function syncAllState() {
        const allTargetsChecked = targets.length > 0 && targets.every(cb => cb.checked);
        allCb.checked = allTargetsChecked;
        
        targets.forEach(cb => cb.disabled = allTargetsChecked);
        
        exempts.forEach(cb => {
          cb.checked = false;
          cb.disabled = allTargetsChecked;
        });
      }

      allCb.addEventListener('change', function() {
        console.log('üîµ "All" clicked:', this.checked);
        applyAllState(this.checked);
      });

      targets.forEach(cb => {
        cb.addEventListener('change', function() {
          console.log('üü¢ Target clicked:', this.value, this.checked);
          
          if (allCb.checked) {
            allCb.checked = false;
            applyAllState(false);
          }
          
          syncAllState();
        });
      });

      exempts.forEach(cb => {
        cb.addEventListener('change', function() {
          console.log('üü° Exempt clicked:', this.value, this.checked);
          if (allCb.checked) {
            this.checked = false;
          }
        });
      });

      if (allCb.checked) {
        console.log('üìå Initial state: All is checked');
        applyAllState(true);
      } else {
        syncAllState();
      }
    }

    // =============================================
    // TAXONOMY PARTIAL UPDATES
    // =============================================
    function submitPartial(sourceLevel) {
      console.log(`üîÑ Submitting partial update from ${sourceLevel}...`);
      
      const data = new FormData(form);
      data.append("__partial__", "1");

      fetch(form.action, {
        method: "POST",
        body: data,
        headers: { 
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(response => {
        console.log('üì• Response status:', response.status);
        return response.json();
      })
      .then(resp => {
        console.log('üì¶ Response data:', resp);
        
        if (!resp.success) {
          console.error('‚ùå Response not successful:', resp);
          return;
        }
        
        const tmp = document.createElement("div");
        tmp.innerHTML = resp.html;

        const newLv2 = tmp.querySelector("#lv2-options");
        const newLv3 = tmp.querySelector("#lv3-options");

        if (newLv2 && lv2Box) {
          console.log('‚úÖ Updating Level 2');
          lv2Box.innerHTML = newLv2.innerHTML;
        }
        
        if (newLv3 && lv3Box) {
          console.log('‚úÖ Updating Level 3');
          lv3Box.innerHTML = newLv3.innerHTML;
        }
        
        enhanceTaxonomyScroll();
      })
      .catch(err => {
        console.error('‚ùå Taxonomy update error:', err);
      });
    }

    // =============================================
    // TAXONOMY SCROLL & COUNTS
    // =============================================
    function enhanceTaxonomyScroll() {
      const sections = document.querySelectorAll('.taxonomy-section');
      sections.forEach(section => {
        const box = section.querySelector('.taxonomy-container');
        if (!box) return;
        
        const checks = box.querySelectorAll('input[type="checkbox"]');
        checks.forEach(chk => {
          const oldHandler = chk._taxonomyHandler;
          if (oldHandler) {
            chk.removeEventListener('change', oldHandler);
          }
          
          chk._taxonomyHandler = function() {
            updateSelectedOptions(section);
            updateCounts(section);
            if (this.checked) {
              setTimeout(() => {
                const formCheck = this.closest('.form-check');
                if (formCheck) {
                  formCheck.scrollIntoView({behavior:'smooth', block:'center'});
                }
              }, 80);
            }
          };
          
          chk.addEventListener('change', chk._taxonomyHandler);
        });
        
        updateCounts(section);
        updateSelectedOptions(section);
      });
    }

    function updateCounts(section) {
      const box = section.querySelector('.taxonomy-container');
      if (!box) return;
      
      const checks = box.querySelectorAll('input[type="checkbox"]');
      const checked = box.querySelectorAll('input[type="checkbox"]:checked');
      const countEl = section.querySelector('.taxonomy-count');
      
      if (countEl) {
        countEl.textContent = `${checked.length}/${checks.length}`;
      }
      
      section.querySelectorAll('.taxonomy-group').forEach(g => {
        const cAll = g.querySelectorAll('input[type="checkbox"]');
        const cSel = g.querySelectorAll('input[type="checkbox"]:checked');
        const gc = g.querySelector('.option-count');
        if (gc) gc.textContent = `${cSel.length}/${cAll.length}`;
      });
    }

    function updateSelectedOptions(section) {
      const box = section.querySelector('.taxonomy-container');
      const chips = section.querySelector('.selected-options');
      if (!box || !chips) return;
      
      const checks = box.querySelectorAll('input[type="checkbox"]:checked');
      chips.innerHTML = '';
      
      checks.forEach(chk => {
        const label = chk.closest('.form-check')?.querySelector('label');
        if (label) {
          const div = document.createElement('div');
          div.className = 'selected-item';
          div.textContent = label.textContent.trim();
          chips.appendChild(div);
        }
      });
      
      chips.style.display = checks.length > 0 ? 'block' : 'none';
    }

    // =============================================
    // RISK TILES
    // =============================================
    function setupRiskTiles() {
      const tiles = document.querySelectorAll('.risk-item');
      const select = document.getElementById('risk_rating');
      const error = document.getElementById('risk-error');
      const tilesBox = document.getElementById('risk-tiles');

      if (!select) return;

      function choose(val) {
        tiles.forEach(t => t.classList.remove('selected'));
        const tile = document.querySelector(`.risk-item[data-value="${val}"]`);
        if (tile) tile.classList.add('selected');
        
        select.value = val;
        select.setCustomValidity('');
        if (error) error.style.display = 'none';
        if (tilesBox) {
          tilesBox.classList.remove('risk-tiles-invalid');
          tilesBox.setAttribute('aria-invalid', 'false');
        }
      }

      tiles.forEach(t => {
        t.addEventListener('click', () => choose(t.getAttribute('data-value')));
        t.addEventListener('keydown', ev => {
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            t.click();
          }
        });
      });

      if (select.value) {
        const initial = document.querySelector(`.risk-item[data-value="${select.value}"]`);
        if (initial) initial.classList.add('selected');
      }
    }

    // =============================================
    // CHARACTER COUNTER
    // =============================================
    function updateCharCount(input) {
      const charCount = input.value.length;
      const maxLength = parseInt(input.getAttribute('maxlength')) || 30;
      const counter = document.getElementById('name-char-count');
      if (!counter) return;
      
      counter.textContent = charCount;
      counter.classList.remove('text-warning', 'text-danger', 'text-muted');
      
      if (charCount > maxLength * 0.8 && charCount < maxLength) {
        counter.classList.add('text-warning');
      } else if (charCount >= maxLength) {
        counter.classList.add('text-danger');
      } else {
        counter.classList.add('text-muted');
      }
    }

    // =============================================
    // DATE VALIDATION
    // =============================================
    function validateDateNotFuture() {
      const input = document.getElementById('date_identified');
      if (!input) return true;
      
      const today = new Date().toISOString().split('T')[0];
      input.setAttribute('max', today);
      
      if (input.value && input.value > today) {
        input.setCustomValidity('Date cannot be in the future');
        return false;
      } else {
        input.setCustomValidity('');
        return true;
      }
    }

    // =============================================
    // FORM VALIDATION
    // =============================================
    function validateName() {
      const input = document.getElementById('name');
      if (!input) return true;
      
      const v = (input.value || '').trim();
      if (!v || v.length < 3) {
        input.setCustomValidity('Event name must be 3-30 characters');
        return false;
      } else {
        input.setCustomValidity('');
        return true;
      }
    }

    function validateTaxonomy() {
      let ok = true;
      const configs = [
        {boxId:'taxonomy-lv1-container', errId:'lv1-error'},
        {boxId:'lv2-options', errId:'lv2-error'},
        {boxId:'lv3-options', errId:'lv3-error'}
      ];
      
      configs.forEach(({boxId, errId}) => {
        const box = document.getElementById(boxId);
        const err = document.getElementById(errId);
        if (!box || !err) return;
        
        const section = err.closest('.taxonomy-section');
        const anyChecked = !!box.querySelector('input[type="checkbox"]:checked');
        
        if (!anyChecked) {
          ok = false;
          err.style.display = 'block';
          if (section) {
            section.classList.add('is-invalid');
            section.setAttribute('aria-invalid', 'true');
          }
        } else {
          err.style.display = 'none';
          if (section) {
            section.classList.remove('is-invalid');
            section.removeAttribute('aria-invalid');
          }
        }
      });
      
      return ok;
    }

    function validateRisk() {
      const select = document.getElementById('risk_rating');
      const error = document.getElementById('risk-error');
      const tilesBox = document.getElementById('risk-tiles');
      
      if (!select) return true;
      
      const valid = !!select.value;
      
      if (!valid) {
        select.setCustomValidity('Please select a risk rating');
        if (error) error.style.display = 'block';
        if (tilesBox) {
          tilesBox.classList.add('risk-tiles-invalid');
          tilesBox.setAttribute('aria-invalid', 'true');
        }
      } else {
        select.setCustomValidity('');
        if (error) error.style.display = 'none';
        if (tilesBox) {
          tilesBox.classList.remove('risk-tiles-invalid');
          tilesBox.setAttribute('aria-invalid', 'false');
        }
      }
      
      return valid;
    }

    // =============================================
    // FORM SUBMIT HANDLER
    // =============================================
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      const nameOk = validateName();
      const dateOk = validateDateNotFuture();
      const taxOk = validateTaxonomy();
      const riskOk = validateRisk();

      const isValid = form.checkValidity() && nameOk && dateOk && taxOk && riskOk;

      if (!isValid) {
        form.classList.add('was-validated');
        console.log('‚ùå Form validation failed');
        return false;
      }

      const formData = new FormData();

      const fields = [
        'theme',
        'name',
        'date_identified',
        'risk_rating',
        'status',
        'description'
      ];

      fields.forEach(name => {
        const el = form.querySelector(`[name="${name}"]`);
        if (el && el.value) formData.append(name, el.value);
      });

      const controlInPlace = form.querySelector('[name="control_in_place"]');
      if (controlInPlace && controlInPlace.checked) {
        formData.append('control_in_place', 'on');
      }

      form.querySelectorAll('[name="impacted_lines"]:checked')
        .forEach(cb => formData.append('impacted_lines', cb.value));

      form.querySelectorAll('[name="risk_taxonomy_lv1"]:checked')
        .forEach(cb => formData.append('risk_taxonomy_lv1', cb.value));

      form.querySelectorAll('[name="risk_taxonomy_lv2"]:checked')
        .forEach(cb => formData.append('risk_taxonomy_lv2', cb.value));

      form.querySelectorAll('[name="risk_taxonomy_lv3"]:checked')
        .forEach(cb => formData.append('risk_taxonomy_lv3', cb.value));

      const csrf = form.querySelector('[name="csrfmiddlewaretoken"]');
      if (csrf) formData.append('csrfmiddlewaretoken', csrf.value);

      console.log('üì§ Submitting form data...');

      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(r => r.json())
      .then(resp => {
        if (!resp.success || !resp.event_id) {
          console.error('‚ùå Form submission failed:', resp.errors);
          alert('Error saving event. Please review the form.');
          return;
        }

        console.log('‚úÖ Event created successfully:', resp.event_id);

        const detailUrl = `/event/${resp.event_id}/offcanvas/`;
        console.log('üì• Loading event detail:', detailUrl);

        fetch(detailUrl, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(r => r.json())
        .then(detailResp => {
          if (!detailResp.success) {
            console.error('‚ùå Failed loading event detail', detailResp);
            return;
          }

          const offcanvas = document.getElementById('globalOffcanvas');
          const body = offcanvas?.querySelector('.offcanvas-body');
          const title = offcanvas?.querySelector('.offcanvas-title');

          if (body) {
            body.innerHTML = detailResp.html;
          }

          if (title && detailResp.title) {
            title.textContent = detailResp.title;
          }

          console.log('‚úÖ Event detail rendered correctly');
        })
        .catch(err => {
          console.error('‚ùå Error loading event detail:', err);
        });

      })
      .catch(err => {
        console.error('‚ùå Submit error:', err);
        alert('Error saving event. Please try again.');
      });
    });


   
    // =============================================
    // EVENT DELEGATION FOR TAXONOMY
    // =============================================
    lv1Box.addEventListener("change", function(e) {
      if (e.target.type === 'checkbox') {
        console.log('üîµ Level 1 changed:', e.target.value, e.target.checked);
        submitPartial('level1');
      }
    });

    lv2Box.addEventListener("change", function(e) {
      if (e.target.type === 'checkbox') {
        console.log('üü¢ Level 2 changed:', e.target.value, e.target.checked);
        submitPartial('level2');
      }
    });

    // =============================================
    // INITIALIZE EVERYTHING
    // =============================================
    const nameInput = document.getElementById('name');
    if (nameInput) {
      nameInput.addEventListener('input', function() {
        updateCharCount(this);
        validateName();
      });
      updateCharCount(nameInput);
    }

    const dateInput = document.getElementById('date_identified');
    if (dateInput) {
      const today = new Date().toISOString().split('T')[0];
      dateInput.setAttribute('max', today);
      dateInput.addEventListener('input', validateDateNotFuture);
    }

    setupLOBLogic();
    enhanceTaxonomyScroll();
    setupRiskTiles();

    console.log('‚úÖ Offcanvas Event Form initialized successfully');

  }, 200); // üî• AUMENTADO de 100ms a 200ms

})();
</script>