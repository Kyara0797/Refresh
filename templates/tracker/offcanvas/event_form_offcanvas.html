{% load widget_tweaks %}

<div class="offcanvas offcanvas-end"
     tabindex="-1"
     id="offcanvasEvent"
     aria-labelledby="offcanvasEventLabel">

  <!-- HEADER -->
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-bold" id="offcanvasEventLabel">
      {% if creating %}
        <i class="fas fa-plus-circle me-2 text-orange"></i>Add Event
      {% else %}
        <i class="fas fa-edit me-2 text-orange"></i>Edit Event
      {% endif %}
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <!-- BODY -->
  <div class="offcanvas-body">
    <form id="addEventFormOffcanvas"
          method="post"
          action="{% if creating %}
                    {% url 'add_event' %}
                  {% else %}
                    {% url 'edit_event' pk=event.pk %}
                  {% endif %}"
          class="needs-validation"
          novalidate>

      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <!-- ================= ACCORDION ================= -->
      <div class="accordion" id="eventAccordion">

        <!-- BASIC INFORMATION -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#basicInfoSection">
              <i class="fas fa-info-circle me-2"></i>Basic Information
            </button>
          </h2>

          <div id="basicInfoSection"
               class="accordion-collapse collapse show"
               data-bs-parent="#eventAccordion">
            <div class="accordion-body">

              <!-- THEME -->
              <div class="mb-3">
                <label class="form-label fw-semibold">
                  Threat <span class="text-danger">*</span>
                </label>
                {{ form.theme|add_class:"form-select" }}
                {% if form.theme.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.theme.errors|join:", " }}
                  </div>
                {% endif %}
              </div>

              <!-- NAME -->
              <div class="mb-3">
                <label class="form-label fw-semibold">
                  Name <span class="text-danger">*</span>
                </label>
                {{ form.name|add_class:"form-control"|attr:"maxlength=30"|attr:"required=required" }}
                {% if form.name.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.name.errors|join:", " }}
                  </div>
                {% endif %}
              </div>

              <!-- DATE -->
              <div class="mb-3">
                <label class="form-label fw-semibold">
                  Date Identified <span class="text-danger">*</span>
                </label>
                {{ form.date_identified|add_class:"form-control"|attr:"type=date"|attr:"required=required" }}
                {% if form.date_identified.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.date_identified.errors|join:", " }}
                  </div>
                {% endif %}
              </div>

            </div>
          </div>
        </div>

        <!-- CLASSIFICATION -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#sectionClassification">
              <i class="fas fa-tags me-2"></i>Classification
            </button>
          </h2>

          <div id="sectionClassification"
               class="accordion-collapse collapse"
               data-bs-parent="#eventAccordion">
            <div class="accordion-body">

              <!-- RISK RATING (SOURCE OF TRUTH) -->
              <select id="risk_rating"
                      name="risk_rating"
                      required
                      style="display:none;">
                <option value="">Select risk rating</option>
                {% for value, label in form.risk_rating.field.choices %}
                  <option value="{{ value }}"
                    {% if form.risk_rating.value == value %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>

              <label class="form-label fw-semibold">
                Risk Rating <span class="text-danger">*</span>
              </label>

              <div id="risk-tiles" class="risk-rating-container mt-2">
                {% for value, label in form.risk_rating.field.choices %}
                  <div class="risk-item {% if form.risk_rating.value == value %}selected{% endif %}"
                       data-value="{{ value }}">
                    <div class="rating-display">
                      <span class="risk-color risk-{{ value }}"></span>
                      <span class="ms-2">{{ label }}</span>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div id="risk-error"
                   class="invalid-feedback d-block"
                   style="display:none;">
                Please select a risk rating.
              </div>

              <!-- ONSET -->
              <div class="mt-3">
                <label class="form-label fw-semibold">
                  Onset Timeline <span class="text-danger">*</span>
                </label>
                {{ form.onset_timeline|add_class:"form-select" }}
              </div>

            </div>
          </div>
        </div>

        <!-- BUSINESS LINES -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#lobSection">
              <i class="fas fa-building me-2"></i>Business Lines
            </button>
          </h2>

          <div id="lobSection"
               class="accordion-collapse collapse"
               data-bs-parent="#eventAccordion">
            <div class="accordion-body">
              {{ form.impacted_lines }}
            </div>
          </div>
        </div>

        <!-- RISK TAXONOMY -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#taxonomySection">
              <i class="fas fa-sitemap me-2"></i>Risk Taxonomy
            </button>
          </h2>

          <div id="taxonomySection"
               class="accordion-collapse collapse"
               data-bs-parent="#eventAccordion">
            <div class="accordion-body">

              <div class="mb-3">
                <label class="form-label fw-semibold">Level 1</label>
                {{ form.risk_taxonomy_lv1 }}
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Level 2</label>
                {{ form.risk_taxonomy_lv2 }}
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Level 3</label>
                {{ form.risk_taxonomy_lv3 }}
              </div>

            </div>
          </div>
        </div>

        <!-- DESCRIPTION -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#descSection">
              <i class="fas fa-align-left me-2"></i>Description
            </button>
          </h2>

          <div id="descSection"
               class="accordion-collapse collapse"
               data-bs-parent="#eventAccordion">
            <div class="accordion-body">
              {{ form.description|add_class:"form-control"|attr:"rows=4"|attr:"required=required" }}
            </div>
          </div>
        </div>

      </div>

      <!-- ACTIONS -->
      <div class="mt-4 d-flex justify-content-end">
        <button type="submit" class="btn btn-orange px-4">
          <i class="fas fa-save me-2"></i>
          {% if creating %}Save Event{% else %}Update Event{% endif %}
        </button>
      </div>

    </form>
  </div>
</div>

<style>
.text-orange { color: #f26522; }

.btn-orange {
  background-color: #f26522;
  color: white;
  border: none;
}
.btn-orange:hover {
  background-color: #d3541c;
  color: white;
}

.risk-rating-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.risk-item {
  padding: 8px 12px;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  cursor: pointer;
}
.risk-item.selected {
  background: #e9ecef;
  border-color: #f26522;
}
.risk-color {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  display: inline-block;
}
.risk-low { background:#28a745; }
.risk-moderate { background:#ffc107; }
.risk-high { background:#dc3545; }
.risk-critical { background:#6c757d; }
</style>
