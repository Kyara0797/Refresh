{% if themes_page %}
<style>
    /* UX Fiserv: fila clickeable con hover */
    .clickable-row {
        cursor: pointer;
        transition: background-color 0.18s ease-in-out;
    }
    .clickable-row:hover {
        background-color: rgba(255, 102, 0, 0.07) !important;
    }

    /* Importante: evitar que click en dropdown abra el offcanvas */
    .no-row-click * {
        pointer-events: auto !important;
    }
</style>

<div class="table-responsive">
    <table id="themesTable" class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Events</th>
                <th>Name</th>
                <th>Category</th>
                <th>Onset</th>
                <th>Risk</th>
                <th>Status</th>
                <th class="text-end"></th>
            </tr>
        </thead>

        <tbody>
        {% for t in themes_page %}
            <tr class="clickable-row"
                onclick="openThemeDetailOffcanvas({{ t.id }})">

                <!-- EVENTS COUNT -->
                <td>{{ t.active_event_count|default:0 }}</td>

                <!-- NAME -->
                <td class="fw-semibold text-primary">
                    {{ t.name }}
                </td>

                <td>{{ t.category.name }}</td>
                <td>{{ t.get_onset_timeline_display }}</td>

                <!-- RISK -->
                <td>
                    <span class="badge bg-{{ t.get_risk_color }}">
                        {{ t.get_risk_rating_display }}
                    </span>
                </td>

                <!-- STATUS -->
                <td>
                    {% if t.is_active %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-secondary">Archived</span>
                    {% endif %}
                </td>

                <!-- ACTIONS -->
                <td class="text-end no-row-click" onclick="event.stopPropagation();">

                    <div class="dropdown">
                        <button class="btn btn-link text-muted p-0"
                                data-bs-toggle="dropdown"
                                onclick="event.stopPropagation();">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>

                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">

                            <!-- DETAILS â€” abre offcanvas -->
                            <li>
                                <button class="dropdown-item"
                                        onclick="openThemeDetailOffcanvas({{ t.id }}); event.stopPropagation();">
                                    <i class="fas fa-eye me-2 text-orange"></i>Details
                                </button>
                            </li>

                            <!-- ADD EVENT -->
                            <li>
                                <button class="dropdown-item"
                                        onclick="openAddEventOffcanvas({{ t.id }}); event.stopPropagation();">
                                    <i class="fas fa-plus me-2 text-orange"></i>Add Event
                                </button>
                            </li>

                            <!-- EDIT -->
                            <li>
                                <button type="button"
                                        class="dropdown-item"
                                        onclick="openEditThemeOffcanvas({{ t.id }}); event.stopPropagation();">
                                    <i class="fas fa-pen me-2 text-orange"></i>Edit
                                </button>
                            </li>

                            <li><hr class="dropdown-divider"></li>

                            <!-- ARCHIVE / RESTORE -->
                            <li>
                                <form method="post"
                                      action="{% url 'toggle_theme_active' pk=t.id %}"
                                      onclick="event.stopPropagation();">
                                    {% csrf_token %}
                                    <button class="dropdown-item text-danger">
                                        <i class="fas fa-box-archive me-2"></i>
                                        {% if t.is_active %}Archive{% else %}Restore{% endif %}
                                    </button>
                                </form>
                            </li>

                        </ul>
                    </div>
                </td>
            </tr>

        {% empty %}
        <tr>
            <td colspan="7" class="text-center py-4">No threats found.</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- PAGINATION -->
{% if themes_page.has_other_pages and not show_all_themes %}
<div class="px-4 py-3 border-top themes-pagination">
    <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">
            Showing {{ themes_page.start_index }} - {{ themes_page.end_index }}
            of {{ themes_page.paginator.count }} threats
        </small>

        <nav>
            <ul class="pagination pagination-sm mb-0" id="themesPagination">

                {% if themes_page.has_previous %}
                <li class="page-item">
                    <button type="button" 
                            class="page-link" 
                            data-page="{{ themes_page.previous_page_number }}"
                            aria-label="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </li>
                {% endif %}
                
                {% for num in themes_page.paginator.page_range %}
                    {% if themes_page.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > themes_page.number|add:'-3' and num < themes_page.number|add:'3' %}
                    <li class="page-item">
                        <button type="button" 
                                class="page-link" 
                                data-page="{{ num }}">
                            {{ num }}
                        </button>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if themes_page.has_next %}
                <li class="page-item">
                    <button type="button" 
                            class="page-link" 
                            data-page="{{ themes_page.next_page_number }}"
                            aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </li>
                {% endif %}

            </ul>
        </nav>
    </div>
</div>

{% elif show_all_themes %}
<div class="px-4 py-3 border-top">
    <small class="text-muted">
        Showing all {{ themes_page.paginator.count }} threats
    </small>
</div>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="fas fa-exclamation-triangle fa-2x text-muted mb-3"></i>
    <p class="text-muted">No threats found.</p>
</div>
{% endif %}
